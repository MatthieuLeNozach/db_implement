<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <title>Extract PO</title>
    <style>
        .container {
            max-width: 1400px; /* Reduced from 1800px */
            margin-left: auto;
            margin-right: auto;
            padding: 0 1rem;
        }
        
        .app-title {
            text-align: center;
            font-size: 2.2rem; /* Reduced from 3rem */
            font-weight: bold;
            margin: 1.5rem 0 0.8rem; /* Reduced margins */
        }

        .tutorial-section {
            margin: 1.5rem 0; /* Reduced from 2rem */
        }

        .tutorial-dropdown {
            background: var(--pico-card-background-color);
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-border-color);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .tutorial-dropdown:hover {
            border-color: var(--pico-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tutorial-header {
            padding: 1rem 1.5rem; /* Reduced from 1.5rem 2rem */
            cursor: pointer;
            background: var(--pico-background-color);
            border-bottom: 1px solid var(--pico-muted-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            list-style: none;
        }

        .tutorial-header:hover {
            background: var(--pico-primary-background);
        }

        .tutorial-header h2 {
            margin: 0;
            color: var(--pico-primary);
            font-size: 1.2rem; /* Reduced from 1.5rem */
        }

        .tutorial-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--pico-muted-color);
            font-size: 0.85rem; /* Reduced from 0.9rem */
            font-weight: 500;
        }

        .toggle-text {
            font-style: italic;
        }

        .toggle-icon {
            font-size: 1rem; /* Reduced from 1.2rem */
            transition: transform 0.3s ease;
            color: var(--pico-primary);
        }

        .tutorial-dropdown[open] .toggle-icon {
            transform: rotate(180deg);
        }

        .tutorial-dropdown[open] .toggle-text::after {
            content: " (cliquez pour masquer)";
        }

        .tutorial-container {
            padding: 1.5rem; /* Reduced from 2rem */
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tutorial-intro {
            text-align: center;
            margin-bottom: 1.5rem; /* Reduced from 2rem */
            font-size: 1rem; /* Reduced from 1.1rem */
            color: var(--pico-muted-color);
        }

        .tutorial-steps {
            display: grid;
            gap: 1.5rem; /* Reduced from 2rem */
            margin-bottom: 1.5rem; /* Reduced from 2rem */
        }

        .tutorial-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem; /* Reduced from 1.5rem */
            padding: 1rem; /* Reduced from 1.5rem */
            background: var(--pico-background-color);
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-muted-border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .tutorial-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .step-number {
            flex-shrink: 0;
            width: 32px; /* Reduced from 40px */
            height: 32px; /* Reduced from 40px */
            background: var(--pico-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem; /* Reduced from 1.2rem */
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            margin: 0 0 0.4rem 0; /* Reduced from 0.5rem */
            color: var(--pico-primary);
            font-size: 1.1rem; /* Added explicit size */
        }

        .step-content p {
            margin: 0 0 0.8rem 0; /* Reduced from 1rem */
            color: var(--pico-color);
            font-size: 0.9rem; /* Added explicit size */
        }

        .step-content li {
            font-size: 0.9rem; /* Added explicit size */
            margin: 0.3rem 0; /* Reduced spacing */
        }

        .step-image {
            text-align: center;
            margin-top: 0.5rem;
        }

        .step-image img {
            max-width: 100%;
            height: auto;
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-muted-border-color);
        }

        .tutorial-tips {
            background: var(--pico-background-color);
            padding: 1rem; /* Reduced from 1.5rem */
            border-radius: var(--pico-border-radius);
            border-left: 4px solid var(--pico-primary);
        }

        .tutorial-tips h3 {
            margin: 0 0 0.8rem 0; /* Reduced from 1rem */
            color: var(--pico-primary);
            font-size: 1.1rem; /* Added explicit size */
        }

        .tutorial-tips ul {
            margin: 0;
            padding-left: 1.2rem; /* Reduced from 1.5rem */
        }

        .tutorial-tips li {
            margin-bottom: 0.4rem; /* Reduced from 0.5rem */
            color: var(--pico-color);
            font-size: 0.9rem; /* Added explicit size */
        }

        @media (max-width: 768px) {
            .tutorial-header {
                padding: 0.8rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .tutorial-container {
                padding: 1rem;
            }
            
            .tutorial-step {
                flex-direction: column;
                text-align: center;
            }
            
            .step-number {
                margin: 0 auto 0.8rem;
            }
            
            .tutorial-header h2 {
                font-size: 1.1rem;
            }
            
            .app-title {
                font-size: 1.8rem;
            }
        }
        
        .drag-drop-area {
            border: 2px dashed var(--pico-muted-border-color);
            border-radius: var(--pico-border-radius);
            padding: 2rem; /* Reduced from 3rem */
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }
        
        .drag-drop-area h2 {
            font-size: 1.3rem; /* Reduced from default */
            margin-bottom: 0.5rem;
        }
        
        .drag-drop-area p {
            font-size: 0.9rem; /* Reduced from default */
            margin: 0;
        }
        
        .drag-drop-area:hover, .drag-drop-area.dragover {
            border-color: var(--pico-primary);
            background-color: var(--pico-background-color);
        }
        
        .drag-drop-area input[type="file"] {
            display: none;
        }
        
        .file-info {
            display: none;
        }
        
        .theme-switcher {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem; /* Reduced from 0.5rem */
            border-radius: var(--pico-border-radius);
            background: var(--pico-card-background-color);
            border: var(--pico-border-width) solid var(--pico-border-color);
        }
        
        .theme-toggle select {
            font-size: 0.8rem; /* Reduced size */
            padding: 0.2rem 0.4rem;
            margin: 0;
        }
        
        .results-section {
            margin-top: 1.5rem; /* Reduced from 2rem */
            padding: 1rem;
            background: var(--pico-card-background-color);
            border-radius: var(--pico-border-radius);
        }
        
        .results-section h2 {
            font-size: 1.4rem; /* Reduced from default */
            margin-bottom: 1rem;
        }
        
        .results-section h3 {
            font-size: 1.2rem; /* Reduced from default */
        }
        
        .results-section h4 {
            font-size: 1.1rem; /* Reduced from default */
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1.5rem; /* Reduced from 2rem */
        }
        
        .copy-button {
            background: var(--pico-primary);
            color: white;
            border: none;
            padding: 0.2rem 0.4rem; /* Reduced from 0.25rem 0.5rem */
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem; /* Reduced from 0.8rem */
            margin-left: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .copy-button:hover {
            background: var(--pico-primary-hover);
        }
        
        .copy-button:active {
            transform: scale(0.95);
        }
        
        .copy-button.copied {
            background: #28a745;
        }
        
        .field-with-copy {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.4rem 0; /* Reduced from 0.5rem */
        }
        
        .table-copy-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem; /* Reduced from 2rem */
            margin-top: 1rem;
        }
        
        .results-left {
            background: var(--pico-card-background-color);
            padding: 1.2rem; /* Reduced from 1.5rem */
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-border-color);
        }
        
        .results-right {
            background: var(--pico-card-background-color);
            padding: 1.2rem; /* Reduced from 1.5rem */
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-border-color);
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Styles for "Sélectionner un client" */
        label[for="customerSelect"] {
            font-size: 1.2rem; /* Reduced from 1.5rem */
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        #customerSelect {
            font-size: 1rem; /* Reduced from 1.1rem */
            padding: 0.5rem 0.7rem; /* Reduced from 0.6rem 0.8rem */
        }
        
        /* Form elements sizing */
        button[type="submit"] {
            font-size: 1rem; /* Ensure consistent button size */
            padding: 0.6rem 1.2rem; /* Reduced padding */
        }
        
        /* Table styling */
        table {
            font-size: 0.9rem; /* Reduced table font size */
        }
        
        table th {
            font-size: 0.85rem; /* Smaller header font */
            padding: 0.5rem; /* Reduced padding */
        }
        
        table td {
            padding: 0.4rem 0.5rem; /* Reduced padding */
        }
        
        /* List styling in results */
        .results-section ul {
            font-size: 0.9rem;
        }
        
        .results-section li {
            margin: 0.3rem 0;
        }
        
        /* Debug section */
        details summary {
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        
        details pre {
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        /* Responsive text scaling */
        @media (max-width: 1200px) {
            .app-title {
                font-size: 2rem;
            }
            
            .tutorial-header h2 {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 768px) {
            .app-title {
                font-size: 1.8rem;
            }
            
            .drag-drop-area {
                padding: 1.5rem;
            }
            
            .drag-drop-area h2 {
                font-size: 1.1rem;
            }
            
            .drag-drop-area p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <nav class="container-fluid" style="margin-bottom: 1rem;">
    <ul>
        <li><strong>📦 Commande Tools</strong></li>
    </ul>
    <ul>
        <li><a href="{{ url_for('index') }}">📑 Extracteur de bons de commande</a></li>
        <li><a href="{{ url_for('elior_page') }}">🚚 Générateur bon Elior</a></li>
    </ul>
    </nav>
    <div class="theme-switcher">
        <div role="group" class="theme-toggle">
            <select id="themeSelector" onchange="setTheme(this.value)">
                <option value="auto">🌓 Auto</option>
                <option value="light">☀️ Light</option>
                <option value="dark">🌙 Dark</option>
            </select>
        </div>
    </div>

    <main class="container">
        <div class="app-title">Extraction de bon de commande</div>
        <div class="placeholder">  </div>
        


        <section class="tutorial-section">
                    <details class="tutorial-dropdown">
                        <summary class="tutorial-header">
                            <h2>📚 Comment utiliser l'application:</h2>
                            <span class="tutorial-toggle">
                                <span class="toggle-text">Cliquez ici pour voir le tutoriel</span>
                                <span class="toggle-icon">▼</span>
                            </span>
                        </summary>
                        
                        <div class="tutorial-container">
                            <p class="tutorial-intro">
                                Suivez ces étapes pour extraire automatiquement les données des bons de commande PDF :
                            </p>
                            
                            <div class="tutorial-steps">
                                <div class="tutorial-step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <h3>Sélection du client</h3>
                                        <p>Choisisr le client correspondant au bon de commande dans la liste déroulante (Compass, SodexoClassique, Elior...).</p>
                                        <div class="step-image">
                                            <img src="static/tutorial/client.png" alt="Sélection du client" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tutorial-step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <h3>Téléchargement du fichier PDF</h3>
                                        <p>Glisser-déposer le fichier PDF dans la zone prévue, ou cliquer pour parcourir les fichiers sur l'ordinateur.</p>
                                        <div class="step-image">
                                            <img src="static/tutorial/ouvrir.png" alt="Téléchargement du fichier PDF" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tutorial-step">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <h3>Lancement de l'extraction</h3>
                                        <p>Cliquer sur le bouton "Lancer le traitement" pour démarrer l'analyse automatique du bon de commande.</p>
                                        <div class="step-image">
                                            <img src="static/tutorial/fichier.png" alt="Lancement de l'extraction" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tutorial-step">
                                    <div class="step-number">4</div>
                                    <div class="step-content">
                                        <h3>Utilisation des données d'en-tête</h3>
                                        <p>Les données d'en-tête permettent de remplir la partie supérieure de la Commande Vente dans BC.</p>
                                        <li>Copier les données dans le presse-papier à l'aide du bouton</li>
                                        <li>Coller les valeurs dans le champ correspondant dans BC </li>
                                        <div class="step-image">
                                            <img src="static/tutorial/tuto_entete.png" alt="Consultation des résultats" />
                                        </div>
                                    </div>
                                </div>

                    <div class="tutorial-step">
                                    <div class="step-number">5</div>
                                    <div class="step-content">
                                        <h3>Utilisation des données du tableau</h3>
                                        <p>Les données extraites apparaîtront dans un tableau organisé. Il est possible de coller l'ensemble des lignes à l'aide du bouton, ou sélectionner les lignes individuellement.</p>
                                        <li>Attention à bien activer la première ligne dans le tableau de commande BC en cliquant sur la flèche à gauche de la ligne.</li>
                                        <li>Les données "valides" sont prêtes à être utilisées directement</li>
                                        <li>Les données "erronées" nécessitent une vérification manuelle</li>
                                        <div class="step-image">
                                            <img src="static/tutorial/tuto_tableau.png" alt="Consultation des résultats" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tutorial-tips">
                                <h3>💡 Conseils d'utilisation</h3>
                                <ul>
                                    <li>Vérifiez que le format correspond bien au client sélectionné</li>
                                </ul>
                            </div>
                        </div>
                    </details>
                </section>


        <section>
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                <label for="customerSelect">Sélectionner un client</label>
                <select id="customerSelect" name="customer" required>
                    <option value="" disabled selected>Choisir une option</option>
                    <option value="Compass">Compass</option>
                    <option value="SodexoClassique">SodexoClassique</option>
                    <option value="Elior">Elior</option>
                </select>

                <div class="drag-drop-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" name="file" id="fileInput" accept=".pdf" required>
                    <h2>📁 Déposez un fichier PDF ici ou cliquez pour parcourir</h2>
                    <p>Sélectionnez un fichier PDF à importer (max 16 Mo)</p>
                </div>

                <div id="fileInfo" class="file-info">
                    <article>
                        <strong>Fichier séléctionné:</strong> <span id="fileName"></span>
                    </article>
                </div>

                <button type="submit" id="uploadBtn" disabled>🚀 Lancer le traiement</button>
            </form>

            <div id="loading" class="loading">
                <article>
                    <h3>Traitement en cours...</h3>
                    <progress></progress>
                </article>
            </div>
        </section>

        {% if results %}
        <section class="results-section">
            <h2>📊 Résumé du traitement</h2>
            <article>
                <h3>🏢 Client: {{ results.customer }}</h3>
                <p><strong>📁 Fichier:</strong> {{ results.timestamp }}</p>
                
                {% if results.summary %}
                    {% set summary = results.summary %}
                    
                    <div class="results-grid">
                        <div class="results-left">
                            {% if summary.header_info %}
                            <div>
                                <h4><strong>📋 Informations d’en-tête</strong></h4>
                                <ul>
                                    {% for key, value in summary.header_info.items() %}
                                        <li class="field-with-copy">
                                            <span><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value or 'N/A' }}</span>
                                            {% if value and value != 'N/A' %}
                                                <button class="copy-button" onclick="copyToClipboard('{{ value }}', this)">📋 Copier</button>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            {% if summary.processing_summary %}
                            <div>
                                <h4><strong>📊 Résumé du traitement</strong></h4>
                                {% set proc_sum = summary.processing_summary %}
                                <ul>
                                    <li><strong>Total rows processed:</strong> {{ proc_sum.total_rows or 0 }}</li>
                                    <li><strong>✅ Lignes valides:</strong> {{ proc_sum.clean_rows or 0 }}</li>
                                    <li><strong>❌ Lignes erronées:</strong> {{ proc_sum.faulty_rows or 0 }}</li>
                                    {% if proc_sum.issues_found %}
                                        <li><strong>🔧 Problèmes détectés :</strong>
                                            <ul>
                                                {% for issue, count in proc_sum.issues_found.items() %}
                                                    <li>{{ issue.replace('_', ' ').title() }}: {{ count }}</li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="results-right">
                            {% if summary.clean_data %}
                            <div>
                                <div class="table-copy-container">
                                    <h4><strong>✅ Tableau de commande ({{ summary.clean_data|length }} rows)</strong></h4>
                                    <button class="copy-button" onclick="copyTableData(this)">📋 Copier le tableau</button>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table id="cleanDataTable">
                                        <thead>
                                            <tr>
                                                {% if summary.clean_data[0] %}
                                                    {% for header in summary.clean_data[0].keys() %}
                                                        <th>{{ header.replace('_', ' ').title() }}</th>
                                                    {% endfor %}
                                                {% endif %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in summary.clean_data %}
                                            <tr>
                                                {% for value in row.values() %}
                                                    <td>{{ value }}</td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                            
                    
                    {% if summary.faulty_data %}
                    <div style="margin-top: 2rem;">
                        <h4><strong>❌ Lignes erronées ({{ summary.faulty_data|length }} rows)</strong></h4>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        {% if summary.faulty_data[0] %}
                                            {% for header in summary.faulty_data[0].keys() %}
                                                <th>{{ header.replace('_', ' ').title() }}</th>
                                            {% endfor %}
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in summary.faulty_data %}
                                    <tr style="background-color: #ffebee;">
                                        {% for value in row.values() %}
                                            <td>{{ value }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </article>

                                        <details>
                                <summary><strong>🔍 Debug Info</strong></summary>
                                <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto;">
                                    {% with messages = get_flashed_messages(with_categories=true) %}
                                        {% if messages %}
                                            <div class="flash-messages" style="margin-bottom: 1rem;">
                                                <h5>📨 Flash Messages:</h5>
                                                {% for category, message in messages %}
                                                    <div style="margin: 0.5rem 0; padding: 0.5rem; border-radius: 4px; background: {% if category == 'success' %}#e8f5e8{% elif category == 'warning' %}#fff3cd{% elif category == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %};">
                                                        {% if category == 'success' %}🟢{% elif category == 'warning' %}🟡{% elif category == 'error' %}🔴{% else %}ℹ️{% endif %}
                                                        <strong>{{ category.title() }}:</strong> {{ message }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                    
                                    <h5>📋 Summary Data:</h5>
                                    <pre>{{ summary | pprint }}</pre>
                                </div>
                            </details>
                        </div>
                    </div>

            <form method="post" action="{{ url_for('clear_results') }}">
                <button type="submit" class="secondary">🗑️ Réinitialiser</button>
            </form>
        </section>
        {% endif %}
    </main>

    <script>
        // Copy to clipboard functionality
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(function() {
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // Copy table data (without headers)
        function copyTableData(button) {
            const table = document.getElementById('cleanDataTable');
            if (!table) {
                console.error('Table not found');
                alert('Table not found');
                return;
            }
            
            const rows = table.querySelectorAll('tbody tr');
            let tableData = '';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
                tableData += rowData + '\n';
            });
            
            if (tableData.trim() === '') {
                console.error('No data to copy');
                alert('No data to copy');
                return;
            }
            
            navigator.clipboard.writeText(tableData.trim()).then(function() {
                const originalText = button.textContent;
                button.textContent = '✅ Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy table data: ', err);
                alert('Failed to copy table data to clipboard. Error: ' + err.message);
            });
        }

        // Theme Management
        function setTheme(theme) {
            if (theme === 'auto') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', systemTheme);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            localStorage.setItem('theme', theme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            document.getElementById('themeSelector').value = savedTheme;
            setTheme(savedTheme);
        }

        function setupSystemThemeListener() {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', () => {
                const currentTheme = localStorage.getItem('theme') || 'auto';
                if (currentTheme === 'auto') {
                    setTheme('auto');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            setupSystemThemeListener();
        });

        // File Upload Functionality
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const dragArea = document.querySelector('.drag-drop-area');
        const uploadForm = document.getElementById('uploadForm');
        const loading = document.getElementById('loading');

        // File input change handler
        fileInput.addEventListener('change', handleFileSelect);

        // Form submission handler
        uploadForm.addEventListener('submit', function() {
            loading.style.display = 'block';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Processing...';
        });

        // Drag and drop handlers
        dragArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragArea.classList.add('dragover');
        });

        dragArea.addEventListener('dragleave', () => {
            dragArea.classList.remove('dragover');
        });

        dragArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dragArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files[0];
            const customerSelect = document.getElementById('customerSelect');

            if (file) {
                // Check file type
                if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
                    alert('Please select a PDF file only.');
                    fileInput.value = '';
                    return;
                }

                // Check file size (16MB = 16 * 1024 * 1024 bytes)
                if (file.size > 16 * 1024 * 1024) {
                    alert('File size exceeds 16MB limit. Please choose a smaller file.');
                    fileInput.value = '';
                    return;
                }

                fileName.textContent = file.name;
                fileInfo.style.display = 'block';
                
                // Enable upload button only if both file and customer are selected
                uploadBtn.disabled = !(file && customerSelect.value);
            } else {
                fileInfo.style.display = 'none';
                uploadBtn.disabled = true;
            }
        }

        // Enable upload button when customer is selected
        document.getElementById('customerSelect').addEventListener('change', function() {
            const file = fileInput.files[0];
            uploadBtn.disabled = !(file && this.value);
        });
    </script>
</body>
</html>